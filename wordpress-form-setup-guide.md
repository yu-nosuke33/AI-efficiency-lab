# WordPress アンケートフォーム設定手順

## 問題の概要

「Failed to fetch」エラーは、WordPressサイトからGoogle Apps Script (GAS) への
クロスオリジンリクエストがブラウザによってブロックされることで発生します。

## 解決方法: 5ステップ

### ステップ1: GASコードを更新

1. Google Apps Scriptエディタを開く
2. 既存のコードを `wordpress-survey-form-gas.js` の内容で置き換える
3. 保存する（Ctrl+S / Cmd+S）

**重要な変更点:**
- `doGet` 関数を追加（プリフライトリクエスト対応）
- エラーハンドリングを強化
- レスポンス形式を統一

### ステップ2: OpenAI APIキーを安全に設定

**セキュリティのため、APIキーはスクリプトプロパティに保存します。**

1. GASエディタで「プロジェクトの設定」（歯車アイコン）をクリック
2. 「スクリプト プロパティ」タブを開く
3. 「スクリプト プロパティを追加」をクリック
4. 以下を入力:
   - プロパティ: `OPENAI_API_KEY`
   - 値: `sk-proj-...`（あなたのOpenAI APIキー）
5. 「スクリプト プロパティを保存」をクリック

### ステップ3: GASを再デプロイ（最重要）

**これが最も重要なステップです！**

1. GASエディタで「デプロイ」→「デプロイを管理」を開く
2. 既存のデプロイがある場合、✏️（編集）アイコンをクリック
3. 以下の設定を確認:
   - 種類: **ウェブアプリ**
   - 説明: 「CORS対応版」など（任意）
   - 次のユーザーとして実行: **自分**
   - アクセスできるユーザー: **全員** ← **これが重要！**
4. 「デプロイ」をクリック
5. 新しいWebアプリのURLが表示されるのでコピー
   - 形式: `https://script.google.com/macros/s/xxxxx/exec`

**⚠️ 注意:**
- 「アクセスできるユーザー」が「全員」でないと動作しません
- 新しいURLが発行された場合、必ずWordPress側も更新してください

### ステップ4: WordPressのHTMLを更新

1. WordPressの管理画面にログイン
2. お問い合わせページの編集画面を開く
3. 既存のフォームコードを `wordpress-survey-form.html` の内容で置き換える
4. `CONFIG.GAS_URL` の値を、ステップ3でコピーしたURLに変更:

```javascript
const CONFIG = {
  // ★ここにステップ3のURLを貼り付け★
  GAS_URL: 'https://script.google.com/macros/s/xxxxx/exec',

  AUTH_TOKEN: 'survey2024_secure_token_Gr0wUp_xyz789',
  DEBUG_MODE: false,  // デバッグ時は true に変更
  TIMEOUT: 30000
};
```

5. ページを保存

### ステップ5: 動作確認

1. ブラウザでWordPressのお問い合わせページを開く
2. ブラウザの開発者ツールを開く（F12キー）
3. Consoleタブを確認
4. フォームに適当な内容を入力
5. 「要約する」ボタンをクリック
6. 以下を確認:
   - Consoleにエラーが出ていないか
   - 要約が生成されるか（最大30秒程度かかります）

**エラーが出る場合:**
- Networkタブでリクエストの詳細を確認
- GASの「実行数」→「実行ログ」を確認

## トラブルシューティング

### エラー1: 「Failed to fetch」

**原因:**
- GASのデプロイ設定が「全員」になっていない
- GASのURLが間違っている
- ネットワーク接続の問題

**解決方法:**
1. ステップ3を再度実行（特に「アクセスできるユーザー: 全員」を確認）
2. ブラウザのキャッシュをクリア（Ctrl+Shift+Del）
3. 別のブラウザで試す
4. GASのURLをコピー&ペーストし直す

### エラー2: 「認証エラー」

**原因:**
- AUTH_TOKEN が一致していない

**解決方法:**
1. GASコードの `AUTH_TOKEN_WP` の値を確認
2. WordPressコードの `CONFIG.AUTH_TOKEN` の値を確認
3. 両方が完全に一致しているか確認

### エラー3: 「サーバーから不正なレスポンス」

**原因:**
- GASがJSONではなくHTMLを返している
- デプロイに失敗している

**解決方法:**
1. GASで `testDoPostSummarize()` 関数を実行してテスト
2. 実行ログを確認
3. エラーがなければ、再デプロイする

### エラー4: 「API呼び出し失敗」

**原因:**
- OpenAI APIキーが無効
- APIクレジットが不足
- APIキーの設定が間違っている

**解決方法:**
1. OpenAIのダッシュボードでAPIキーの状態を確認
2. クレジット残高を確認
3. スクリプトプロパティの設定を確認
4. 新しいAPIキーを発行して設定し直す

## デバッグモードの使い方

詳細なエラー情報を確認したい場合:

1. WordPressコードの `DEBUG_MODE` を `true` に変更:

```javascript
const CONFIG = {
  GAS_URL: 'https://...',
  AUTH_TOKEN: '...',
  DEBUG_MODE: true,  // ← true に変更
  TIMEOUT: 30000
};
```

2. ページを再読み込み
3. フォームの下部に「デバッグ情報」セクションが表示される
4. 操作を実行すると、詳細なログが表示される

**注意:** 本番環境では必ず `false` に戻してください。

## GASの各関数のテスト方法

### 要約機能のテスト

GASエディタで以下の関数を実行:

```javascript
testDoPostSummarize()
```

実行後、「実行ログ」タブで結果を確認。

### 保存機能のテスト

GASエディタで以下の関数を実行:

```javascript
testDoPostSubmit()
```

実行後、スプレッドシートに新しい行が追加されているか確認。

## セキュリティチェックリスト

- ✅ OpenAI APIキーをスクリプトプロパティに保存した
- ✅ APIキーをコード内に直接書いていない
- ✅ AUTH_TOKEN を推測されにくい値に変更した
- ✅ 本番環境で DEBUG_MODE を false にした
- ✅ HTTPSでアクセスできることを確認した

## よくある質問

### Q1: GASのテストは成功するのに、WordPressから呼び出すと失敗する

**A:** GASのデプロイ設定が「全員」になっていない可能性が高いです。
ステップ3を再度確認してください。

### Q2: 要約の生成に時間がかかる

**A:** OpenAI APIの応答に10〜30秒かかることがあります。
タイムアウト時間は30秒に設定されているので、それ以上かかる場合は
ネットワークやAPIの問題を確認してください。

### Q3: スプレッドシートに保存されない

**A:**
1. シート名が「フォームの回答 1」になっているか確認
2. GASがスプレッドシートにアクセスできるか確認
3. `testDoPostSubmit()` 関数でテストしてみる

### Q4: APIキーが漏洩した場合

**A:**
1. すぐにOpenAIのダッシュボードで該当のAPIキーを無効化
2. 新しいAPIキーを発行
3. スクリプトプロパティで新しいキーに更新
4. GitHubなどにコードを公開している場合、履歴からも削除

## まとめ

「Failed to fetch」エラーの解決には、主に以下が重要です:

1. ✅ GASのデプロイ設定を「アクセスできるユーザー: 全員」にする
2. ✅ 最新のコードで再デプロイする
3. ✅ 新しいURLをWordPress側に反映する
4. ✅ ブラウザのキャッシュをクリアする

この手順で解決しない場合は、ブラウザの開発者ツール (F12) の
ConsoleタブとNetworkタブで詳細なエラー情報を確認してください。
